{% comment %}
Timer Widget Block - This loads the Preact widget on product pages
{% endcomment %}

{% if block.settings.show_timer %}
  <div class="timer-widget-container" {{ block.shopify_attributes }}>
    {% comment %} Title Section {% endcomment %}
    {% if block.settings.timer_title != blank %}
      <h3 class="timer-title">{{ block.settings.timer_title }}</h3>
    {% endif %}

    {% comment %} Preact Widget Container {% endcomment %}
    <div id="countdown-timer-{{ block.id }}" class="countdown-timer-container">
      <!-- Preact widget will be rendered here -->
    </div>
    
    {% comment %} Load the Timer Widget CSS and Script {% endcomment %}
    <link rel="stylesheet" href="{{ 'timer-widget.css' | asset_url }}">
    <script>
      // Simple script loader for timer widget
      (function() {
        console.log('üîß Timer Widget Block Loading...');
        
        // Load the main timer widget script
        const script = document.createElement('script');
        script.src = "{{ 'index.js' | asset_url }}";
        script.defer = true;
        script.onload = function() {
          console.log('‚úÖ Timer Widget Script Loaded Successfully');
          // Initialize the widget after script loads
          if (window.initializeTimerWidget) {
            console.log('üîß Calling initializeTimerWidget...');
            window.initializeTimerWidget();
          }
        };
        script.onerror = function() {
          console.error('‚ùå Failed to load Timer Widget Script');
        };
        document.head.appendChild(script);
      })();
    </script>

    {% comment %} Description {% endcomment %}
    {% if block.settings.description != blank %}
      <p class="timer-description">{{ block.settings.description }}</p>
    {% endif %}
  </div>
{% else %}
  <div class="timer-disabled" {{ block.shopify_attributes }}>
    <p>Timer is currently disabled. Enable it in block settings.</p>
  </div>
{% endif %}

<style>
  .timer-widget-container {
    margin: 15px 0;
    padding: 0;
  }

  .timer-title {
    text-align: center;
    margin: 0 0 15px 0;
    font-size: {{ block.settings.title_size | default: 24 }}px;
    color: {{ block.settings.title_color | default: '#333' }};
    font-weight: bold;
  }

  .timer-description {
    text-align: center;
    margin: 15px 0 0 0;
    font-size: {{ block.settings.desc_size | default: 14 }}px;
    color: {{ block.settings.desc_color | default: '#666' }};
  }

  .timer-disabled {
    background: #f8f9fa;
    border: 1px dashed #dee2e6;
    padding: 20px;
    text-align: center;
    border-radius: 6px;
    color: #6c757d;
  }
</style>

{% schema %}
{
  "name": "Countdown Timer",
  "target": "section",
  "settings": [
    {
      "type": "header",
      "content": "‚è∞ Timer Configuration"
    },
    {
      "type": "checkbox",
      "id": "show_timer",
      "label": "Enable Timer",
      "default": true
    },
    {
      "type": "text",
      "id": "timer_title", 
      "label": "Timer Title",
      "default": "üî• Limited Time Offer!"
    },
    {
      "type": "text",
      "id": "timer_message",
      "label": "Timer Message", 
      "default": "Hurry! Sale ends in:"
    },
    {
      "type": "text",
      "id": "end_date",
      "label": "End Date & Time",
      "info": "Format: YYYY-MM-DD HH:MM:SS (example: 2024-12-25 23:59:59)",
      "default": "2024-12-31 23:59:59"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Description (optional)",
      "placeholder": "Add additional details about your offer...",
      "default": "Don't miss out on this amazing deal!"
    },
    {
      "type": "header",
      "content": "üîß Advanced Configuration"
    },
    {
      "type": "text",
      "id": "api_url",
      "label": "API Base URL (Advanced)",
      "info": "Leave empty to use default. Only change if you have a custom backend URL.",
      "placeholder": "https://your-backend-domain.com"
    },
    {
      "type": "header",
      "content": "üé® Appearance Settings"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background Color",
      "default": "#fff3cd"
    },
    {
      "type": "color", 
      "id": "border_color",
      "label": "Border Color",
      "default": "#ffc107"
    },
    {
      "type": "color",
      "id": "title_color",
      "label": "Title Color", 
      "default": "#333333"
    },
    {
      "type": "range",
      "id": "title_size",
      "label": "Title Size",
      "min": 16,
      "max": 36,
      "step": 2,
      "unit": "px",
      "default": 24
    },
    {
      "type": "color",
      "id": "message_color",
      "label": "Message Color",
      "default": "#856404" 
    },
    {
      "type": "color",
      "id": "unit_bg",
      "label": "Timer Unit Background",
      "default": "#ffc107"
    },
    {
      "type": "color",
      "id": "unit_text", 
      "label": "Timer Unit Text",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "desc_color",
      "label": "Description Color",
      "default": "#666666"
    },
    {
      "type": "range",
      "id": "desc_size",
      "label": "Description Size",
      "min": 12,
      "max": 20,
      "step": 1,
      "unit": "px", 
      "default": 14
    }
  ]
}
{% endschema %}